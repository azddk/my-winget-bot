name: Update Winget Package

on:
  workflow_dispatch:
    inputs:
      packageId:
        description: 'Package ID (e.g., Ubiquiti.IdentityDesktop.Enterprise)'
        required: true
      version:
        description: 'New Version Number (e.g., 0.90.0)'
        required: true
      installerUrl:
        description: 'Direct Download URL for the Installer'
        required: true
      architecture:
        description: 'Architecture'
        required: true
        default: 'x64'
      scope:
        description: 'Scope (machine or user)'
        required: true
        default: 'machine'

jobs:
  winget-update:
    runs-on: windows-latest
    steps:
      - name: Install WingetCreate
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe
      
      - name: Run Winget Update
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_TOKEN }}
        run: |
          # Combine URL | Arch | Scope so Winget knows EXACTLY which entry to update
          $urlComplex = "${{ inputs.installerUrl }}|${{ inputs.architecture }}|${{ inputs.scope }}"
          
          Write-Host "Processing: $urlComplex"
          
          .\wingetcreate.exe update "${{ inputs.packageId }}" `
            --version "${{ inputs.version }}" `
            --urls "$urlComplex" `
            --token "${{ env.GITHUB_TOKEN }}" `
            --submit
