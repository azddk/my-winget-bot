name: Update Winget Package

on:
  workflow_dispatch:
    inputs:
      packageId:
        description: 'Package ID (e.g., Ubiquiti.IdentityDesktop.Enterprise)'
        required: true
      version:
        description: 'New Version Number (e.g., 0.90.0)'
        required: true
      installerUrl:
        description: 'Direct Download URL for the Installer'
        required: true
      architecture:
        description: 'Architecture (x64, x86, or arm64)'
        required: true
        default: 'x64'
      scope:
        description: 'Scope (machine or user)'
        required: true
        default: 'machine'
      installerType:
        description: 'Installer Type (exe, msi, or burn)'
        required: true
        default: 'exe'

jobs:
  winget-update:
    runs-on: windows-latest
    steps:
      - name: Install WingetCreate
        run: |
          Invoke-WebRequest -Uri https://aka.ms/wingetcreate/latest -OutFile wingetcreate.exe
      
      - name: Run Winget Update
        env:
          GITHUB_TOKEN: ${{ secrets.WINGET_TOKEN }}
        run: |
          # Construct the override string: URL | Architecture | Scope | Type
          # This forces Winget to stop guessing and use exactly what we tell it.
          $urlComplex = "${{ inputs.installerUrl }}|${{ inputs.architecture }}|${{ inputs.scope }}|${{ inputs.installerType }}"
          
          Write-Host "Processing Override String: $urlComplex"
          
          .\wingetcreate.exe update "${{ inputs.packageId }}" `
            --version "${{ inputs.version }}" `
            --urls "$urlComplex" `
            --token "${{ env.GITHUB_TOKEN }}" `
            --submit
